# 오류를 통해 알아보는 React Query의 캐싱 메커니즘

### 발생한 문제

상품 구매 및 addOrder 작업이 정상적으로 완료된 것을 확인했지만, adminPage의 대시보드로 이동해 상품 구매 차트를 확인하면 데이터가 실시간으로 반영되지 않는 문제가 발생

#### 예상되는 원인

1. **React Query의 캐시 갱신 문제**

- React Query는 데이터를 캐싱하여 효율적으로 관리하지만, addOrder 작업 이후에 캐시를 강제로 갱신하지 않으면 새로운 데이터가 차트에 즉시 반영되지 않을 수 있습니다.

- 컴포넌트의 재렌더링과 React 생명주기에서의 데이터 갱신 타이밍이 어긋날 가능성이 있습니다.

2.  Firebase의 실시간 업데이트 지연

- Firebase에서 데이터가 변경되었을 때 실시간으로 데이터가 전달되지 않거나, 클라이언트에서 이를 수신하는 데 지연이 발생할 수 있습니다.

#### 개선 방향

- React Query의 invalidateQueries 또는 refetch 기능을 활용하여 데이터를 강제로 갱신.
- Firebase 실시간 업데이트를 보다 신뢰성 있게 수신하도록 이벤트 핸들러를 최적화.
- 데이터 동기화에 필요한 적절한 타이밍을 설정하여 React 생명주기와 캐싱 메커니즘을 조율.

## 결과

React Query에서 쿼리에 저장되어 있는 캐시값이 업데이트가 되지않도록 설정되어 있었기 때문이였고, 처음에 예상했던 원인 중 1번째의 원인이였다.
결론적으론 react-query에서 쿼리를 무효화하고 자동으로 데이터를 요청하고 갱신하여 캐시에 저장된값을 업데이트 하는 방향으로 오류를 고쳤다.

---

### React Query의 캐싱 메커니즘

React Query는 데이터를 요청한 결과를 캐시에 저장합니다. 이 캐시는 동일한 쿼리 키를 사용하는 요청에 대해 빠르게 데이터를 제공할 수 있어 성능 최적화에 유리합니다. 그러나 이 캐시 값이 항상 최신 상태는 아닐 수 있습니다.

#### 장점:

이미 캐시에 데이터가 있다면 네트워크 요청 없이 즉시 데이터를 반환하므로 빠른 사용자 경험 제공.
서버와의 불필요한 네트워크 통신 감소.

#### 단점:

캐시된 데이터가 오래되었거나 서버의 데이터와 일치하지 않는 경우 정확하지 않은 정보를 표시할 수 있음.

### 쿼리 무효화 (invalidateQueries)란?

React Query에서 쿼리를 무효화(invalidate) 하면, 특정 쿼리 키에 저장된 캐시 데이터를 만료 상태로 표시합니다.
이 상태가 되면 React Query는 다음 조건에서 자동으로 데이터를 다시 요청(fetch)한다.

1. 컴포넌트가 리렌더링될 때.
2. 사용자가 쿼리를 다시 활성화(예: 브라우저 포커스)할 때.
3. 수동으로 쿼리 실행(예: refetch)이 호출될 때.

### 쿼리 무효화의 목적

- 캐시를 제거하지 않고도 데이터 갱신을 트리거:

  - 캐시를 완전히 삭제하지는 않습니다. 기존 데이터를 잠시 동안 유지하고, 새로운 데이터를 요청하는 동안 사용자가 빈 화면을 보지 않도록 합니다.
  - 즉, 무효화는 "이 데이터가 더 이상 최신 상태가 아니다"라는 신호를 React Query에 전달하는 것입니다.

- 자동 갱신:
  - 무효화된 쿼리는 React Query가 자동으로 새로운 데이터를 요청하도록 트리거합니다.

#### 무효화와 갱신의 흐름

1. 데이터가 갱신될 필요가 생김:
   예를 들어, 특정 날짜 범위의 판매 데이터를 가져오고 있는데, 사용자가 날짜를 변경하거나 데이터가 업데이트된 경우.

2. invalidateQueries 호출:
   React Query에 "이 쿼리 키에 해당하는 캐시 데이터가 더 이상 유효하지 않다"라고 알려줌.

3. 자동으로 새로운 데이터를 요청:
   React Query는 기존 캐시를 참고하면서도 새로운 네트워크 요청을 트리거해 최신 데이터를 가져옵니다.

4. 새로운 데이터로 갱신:
   네트워크 요청이 완료되면 캐시를 업데이트하고, 구독 중인 컴포넌트에 최신 데이터를 전달합니다.

### 왜 캐시를 완전히 삭제하지 않을까?

- 사용자 경험 향상:
  캐시를 완전히 삭제하면 새로운 데이터를 요청하는 동안 사용자에게 빈 화면이나 로딩 스피너만 표시될 수 있습니다.
  React Query는 기존 캐시 데이터를 보여주면서 동시에 백그라운드에서 새로운 데이터를 요청하여 전환을 부드럽게 처리합니다.

- 성능 최적화:
  동일한 쿼리에 대해 반복적으로 요청이 들어오면, 캐시 데이터를 사용해 네트워크 요청을 줄일 수 있습니다.

---

**요약**

1. 쿼리 무효화는 캐시를 완전히 삭제하지 않고 "더 이상 유효하지 않다"라고 표시하는 과정입니다.
2. React Query는 무효화된 쿼리에 대해 자동으로 데이터를 요청(fetch)하고 갱신(refresh)합니다.
   이렇게 함으로써 최신 데이터를 표시하면서도 캐싱의 성능 이점을 유지할 수 있습니다
